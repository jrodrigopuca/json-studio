name: Package Extension

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: true
        type: boolean
        default: true

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Get version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript check
        run: npx tsc --noEmit
      
      - name: Run tests
        run: npm test
        continue-on-error: true
      
      - name: Build extension
        run: npm run build:ext
      
      - name: Verify icons exist
        run: |
          echo "Checking for required PNG icons..."
          ls -lh dist/icons/icon-16.png
          ls -lh dist/icons/icon-32.png
          ls -lh dist/icons/icon-48.png
          ls -lh dist/icons/icon-128.png
      
      - name: Package extension
        run: |
          cd dist
          zip -r -q ../json-spark-${{ steps.package_version.outputs.tag }}.zip . -x "*.DS_Store" -x "*.svg" -x "*.map"
          cd ..
          echo "‚úÖ Package created"
          ls -lh json-spark-${{ steps.package_version.outputs.tag }}.zip
          echo ""
          echo "üìã Verifying ZIP contents..."
          unzip -l json-spark-${{ steps.package_version.outputs.tag }}.zip | grep manifest.json || echo "‚ö†Ô∏è  WARNING: manifest.json not found in ZIP!"
      
      - name: Generate package info
        run: |
          echo "## Package Contents" > package-info.txt
          echo "" >> package-info.txt
          unzip -l json-spark-${{ steps.package_version.outputs.tag }}.zip >> package-info.txt
          echo "" >> package-info.txt
          echo "## Package Size" >> package-info.txt
          ls -lh json-spark-${{ steps.package_version.outputs.tag }}.zip | awk '{print $5}' >> package-info.txt
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: json-spark-extension-${{ steps.package_version.outputs.tag }}
          path: |
            json-spark-${{ steps.package_version.outputs.tag }}.zip
            package-info.txt
          retention-days: 90
      
      - name: Create Release
        if: ${{ inputs.create_release }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.package_version.outputs.tag }}
          name: JSON Spark ${{ steps.package_version.outputs.tag }}
          body: |
            ## JSON Spark Extension Release
            
            ### üì¶ Download Instructions
            
            **Two ways to download:**
            
            1. **From this Release (RECOMMENDED)**: 
               - Download `json-spark-${{ steps.package_version.outputs.tag }}.zip` from the Assets section below
               - This is the file ready to upload to Chrome Web Store
            
            2. **From Workflow Artifacts**:
               - Download `json-spark-extension-${{ steps.package_version.outputs.tag }}.zip`
               - Extract it ONCE to get `json-spark-${{ steps.package_version.outputs.tag }}.zip` (the real package)
               - Use that inner ZIP file for Chrome Web Store
            
            ### üì§ Upload to Chrome Web Store
            
            1. Go to [Chrome Web Store Developer Dashboard](https://chrome.google.com/webstore/devconsole)
            2. Click "New Item"
            3. Upload `json-spark-${{ steps.package_version.outputs.tag }}.zip` **WITHOUT unzipping it**
            4. ‚úÖ Chrome will extract and validate the manifest automatically
            
            ‚ö†Ô∏è **IMPORTANT**: Upload the ZIP file as-is. Chrome Web Store handles the extraction.
            
            ### ‚ú® What's Included
            
            - ‚úÖ All PNG icons (16x16, 32x32, 48x48, 128x128)
            - ‚úÖ Manifest v3 with all required permissions
            - ‚úÖ Background service worker
            - ‚úÖ Content script for JSON detection
            - ‚úÖ Popup and options pages
            - ‚úÖ Viewer with all features
            
            ### ÔøΩ Verify Before Upload
            
            You can verify the ZIP structure locally:
            ```bash
            # Extract to a temp folder to check (don't upload the extracted files!)
            unzip -l json-spark-${{ steps.package_version.outputs.tag }}.zip | grep manifest.json
            # Should show: manifest.json (in the root)
            ```
            
            ### üìã Submission Steps
            
            1. Download `json-spark-${{ steps.package_version.outputs.tag }}.zip` from Assets below
            2. Upload ZIP to Chrome Web Store (do not extract first)
            3. Add screenshots (1280x800 or 640x400)
            5. Add promotional images if needed
            6. Fill in store listing details
            7. Submit for review
            
            ---
            
            **Privacy Policy**: [PRIVACY.md](https://github.com/${{ github.repository }}/blob/main/PRIVACY.md)
          files: |
            json-spark-${{ steps.package_version.outputs.tag }}.zip
            package-info.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
